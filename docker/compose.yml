services:
  # Ergs scheduler daemon - fetches data from datasources
  ergs-serve:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: ergs-serve
    command: ["ergs", "serve", "--config", "/config/config.toml"]
    volumes:
      - ergs-data:/data
      - ./config.toml:/config/config.toml:ro,z
    environment:
      - TZ=UTC
    restart: unless-stopped
    depends_on:
      - ergs-init
    healthcheck:
      disable: true

  # Ergs web interface - serves the web UI and API
  ergs-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: ergs-web
    command:
      ["ergs", "web", "--host", "0.0.0.0", "--config", "/config/config.toml"]
    ports:
      - "7117:8080"
    volumes:
      - ergs-data:/data
      - ./config.toml:/config/config.toml:ro,z
    environment:
      - TZ=UTC
    restart: unless-stopped
    depends_on:
      - ergs-serve
      - ergs-init
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/",
        ]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # Ergs importer API - accepts blocks via HTTP API
  ergs-importer:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: ergs-importer
    command:
      [
        "ergs",
        "importer",
        "--host",
        "0.0.0.0",
        "--port",
        "7119",
        "--config",
        "/config/config.toml",
      ]
    ports:
      - "7119:7119"
    volumes:
      - ergs-data:/data
      - ./config.toml:/config/config.toml:ro,z
    environment:
      - TZ=UTC
    restart: unless-stopped
    depends_on:
      - ergs-serve
      - ergs-init
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:7119/health",
        ]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # Init container to set up proper permissions for the data volume
  ergs-init:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: ergs-init
    user: "0:0"
    command:
      ["sh", "-c", "chown -R 1000:1000 /data && echo 'Permissions fixed'"]
    volumes:
      - ergs-data:/data
    restart: "no"

volumes:
  ergs-data:
    driver: local
